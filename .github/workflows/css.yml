name: Build and publish CSS

on:
  push:
    branches: [main, 'claude/**']
    paths:
      - 'tailwind.config.js'
      - 'ui/**/*.gohtml'
      - 'ui/styles/**'
      - '.github/workflows/css.yml'
  release:
    types: [published]

jobs:
  build-css:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x

      - name: Build CSS
        run: task css-local

      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Upload to SFTP
        env:
          BASE_PATH: "www/odio-css/"
          SFTP_HOST: ${{ secrets.FTP_HOST }}
          SFTP_USER: ${{ secrets.FTP_USER }}
          SFTP_PASS: ${{ secrets.FTP_PASS }}
        run: |
          COMMIT_SHORT=$(git rev-parse --short HEAD)

          # Déterminer le chemin de destination
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            # Tag → tags/v0.6.0.css
            VERSION=${GITHUB_REF#refs/tags/}
            REMOTE_PATH="${BASE_PATH}/tags/${VERSION}.css"
            URL_PATH="tags/${VERSION}.css"
          else
            # Branche → main/abc1234.css ou claude-xxx/def5678.css
            BRANCH=${GITHUB_REF#refs/heads/}
            REMOTE_PATH="${BASE_PATH}/${BRANCH}/${COMMIT_SHORT}.css"
            URL_PATH="${BRANCH}/${COMMIT_SHORT}.css"
          fi

          # Upload via lftp (supporte SFTP)
          lftp -c "
            set sftp:auto-confirm yes
            open -u ${SFTP_USER},${SFTP_PASS} sftp://${SFTP_HOST}
            mkdir -p $(dirname ${REMOTE_PATH})
            put ui/static/output.css -o ${REMOTE_PATH}
            bye
          "

          echo "✅ CSS uploaded to https://bobbywan.me/${URL_PATH}"
